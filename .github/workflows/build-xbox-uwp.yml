name: Build - Xbox UWP (.appx)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 0.0.4)"
        required: true
        default: "0.0.4"
        type: string

jobs:
  uwpBuilder:
    name: Xbox UWP Build v${{ inputs.version }}
    runs-on: windows-2022

    steps:
      ###########################
      #         Checkout        #
      ###########################
      - name: "[Pre-install] Pull project"
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      ###########################
      #          Cache          #
      ###########################
      - name: "[Pre-install] Restore 'library' cache"
        uses: actions/cache@v4
        with:
          path: Library
          key: YARG-Library-windows-WSAPlayer
          restore-keys: |
            YARG-Library-windows-
            YARG-Library-

      ###########################
      #     Install Blender     #
      ###########################
      - name: "[Pre-install] Cache Blender"
        id: blender-cache
        uses: actions/cache@v4
        with:
          path: C:\BlenderInstall
          key: blender-3.4.1-windows

      - name: "[Pre-install] Download Blender (3.4.1)"
        if: steps.blender-cache.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path C:\BlenderInstall
          Invoke-WebRequest -Uri "https://download.blender.org/release/Blender3.4/blender-3.4.1-windows-x64.msi" -OutFile "C:\BlenderInstall\blender.msi"
        shell: pwsh

      - name: "[Pre-install] Install Blender (3.4.1)"
        run: |
          Start-Process msiexec.exe -ArgumentList '/i', 'C:\BlenderInstall\blender.msi', '/quiet', '/norestart', 'INSTALLDIR=C:\Blender' -Wait -NoNewWindow
        shell: pwsh

      ###########################
      #    Restore  Packages    #
      ###########################
      - name: "[Pre-install] Install .NET SDK"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: "[Pre-install] Restore NuGet Packages"
        run: |
          dotnet tool install --global NuGetForUnity.Cli
          nugetforunity restore

      ###########################
      #     Install Unity       #
      ###########################
      - name: "[Pre-install] Download Unity Editor installer"
        run: |
          New-Item -ItemType Directory -Force -Path C:\UnityInstallers
          $changeset = "7a0645017be0"
          # Download Unity Editor
          Write-Host "Downloading Unity 2021.3.36f1 Editor..."
          Invoke-WebRequest -Uri "https://download.unity3d.com/download_unity/$changeset/Windows64EditorInstaller/UnitySetup64-2021.3.36f1.exe" -OutFile "C:\UnityInstallers\UnitySetup.exe" -UseBasicParsing
          Write-Host "Downloaded Unity Editor installer."
          # Download UWP Build Support
          Write-Host "Downloading UWP Build Support..."
          Invoke-WebRequest -Uri "https://download.unity3d.com/download_unity/$changeset/TargetSupportInstaller/UnitySetup-Universal-Windows-Platform-Support-for-Editor-2021.3.36f1.exe" -OutFile "C:\UnityInstallers\UnitySetup-UWP.exe" -UseBasicParsing
          Write-Host "Downloaded UWP Build Support installer."
        shell: pwsh
        timeout-minutes: 30

      - name: "[Pre-install] Install Unity Editor"
        run: |
          Write-Host "Installing Unity 2021.3.36f1..."
          $installDir = "C:\Program Files\Unity\2021.3.36f1"
          Start-Process -FilePath "C:\UnityInstallers\UnitySetup.exe" -ArgumentList "/S", "/D=$installDir" -Wait -NoNewWindow
          Write-Host "Unity Editor installed."
          # Install UWP support
          Write-Host "Installing UWP Build Support..."
          Start-Process -FilePath "C:\UnityInstallers\UnitySetup-UWP.exe" -ArgumentList "/S", "/D=$installDir" -Wait -NoNewWindow
          Write-Host "UWP Build Support installed."
          # Verify installation
          $unityExe = "$installDir\Editor\Unity.exe"
          if (Test-Path $unityExe) {
            Write-Host "Unity verified at: $unityExe"
          } else {
            Write-Error "Unity.exe not found after installation!"
            Get-ChildItem -Path "C:\Program Files\Unity" -Recurse -Filter "Unity.exe" -ErrorAction SilentlyContinue
            exit 1
          }
        shell: pwsh
        timeout-minutes: 30

      ###########################
      #    Activate License     #
      ###########################
      - name: "[Pre-install] Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: "[Pre-install] Generate .alf activation file"
        run: |
          $unityExe = "C:\Program Files\Unity\2021.3.36f1\Editor\Unity.exe"
          Write-Host "Generating manual activation file..."
          $process = Start-Process -FilePath $unityExe -ArgumentList @(
            "-batchmode", "-nographics", "-quit",
            "-logFile", "$env:GITHUB_WORKSPACE\alf-generation.log",
            "-createManualActivationFile"
          ) -Wait -PassThru -NoNewWindow
          Write-Host "ALF generation exit code: $($process.ExitCode)"
          $alfFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.alf" -Recurse -ErrorAction SilentlyContinue
          if (-not $alfFiles) {
            $alfFiles = Get-ChildItem -Path "." -Filter "*.alf" -ErrorAction SilentlyContinue
          }
          if ($alfFiles) {
            Write-Host "ALF file found: $($alfFiles[0].FullName)"
          } else {
            Write-Error "No .alf file generated!"
            if (Test-Path "$env:GITHUB_WORKSPACE\alf-generation.log") {
              Get-Content "$env:GITHUB_WORKSPACE\alf-generation.log" -Tail 20
            }
            exit 1
          }
        shell: pwsh

      - name: "[Pre-install] Activate Personal License via game-ci"
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          npm install -g unity-license-activate
          $alfFile = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.alf" | Select-Object -First 1
          Write-Host "Using ALF file: $($alfFile.FullName)"
          unity-license-activate "$env:UNITY_EMAIL" "$env:UNITY_PASSWORD" "$($alfFile.FullName)"
          # Search everywhere for the generated .ulf
          $ulfFiles = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "*.ulf" -Recurse -ErrorAction SilentlyContinue
          if (-not $ulfFiles) {
            $ulfFiles = Get-ChildItem -Path "." -Filter "*.ulf" -ErrorAction SilentlyContinue
          }
          if ($ulfFiles) {
            Write-Host "ULF license file generated: $($ulfFiles[0].FullName)"
            # Write to the correct license location
            $licDir = "C:\ProgramData\Unity"
            New-Item -ItemType Directory -Force -Path $licDir
            Copy-Item $ulfFiles[0].FullName -Destination "$licDir\Unity_lic.ulf"
            Write-Host "License installed to: $licDir\Unity_lic.ulf"
          } else {
            Write-Error "No .ulf file generated! Check for error screenshots."
            Get-ChildItem -Path "." -Filter "*.png" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Error screenshot: $($_.FullName)" }
            exit 1
          }
        shell: pwsh

      - name: "[Pre-install] Disable Licensing Client (force legacy ULF mode)"
        run: |
          # The new Licensing Client checks entitlements and rejects Personal
          # licenses for batch/headless mode. Renaming it forces Unity to fall
          # back to legacy .ulf-based licensing which works for CI.
          $lcPath = "C:\Program Files\Unity\2021.3.36f1\Editor\Data\Resources\Licensing\Client"
          if (Test-Path "$lcPath\Unity.Licensing.Client.exe") {
            Rename-Item "$lcPath\Unity.Licensing.Client.exe" "Unity.Licensing.Client.exe.bak"
            Write-Host "Licensing Client disabled (renamed to .bak)"
          } else {
            Write-Host "Licensing Client not found at expected path, listing:"
            Get-ChildItem -Path "C:\Program Files\Unity\2021.3.36f1\Editor\Data\Resources" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          }
        shell: pwsh

      - name: "[Pre-install] Upload activation artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: activation-artifacts
          path: |
            *.alf
            *.ulf
            *.png
            alf-generation.log
          if-no-files-found: ignore

      ###########################
      #    Unity UWP Build      #
      ###########################
      - name: "[Build] Find Unity Editor"
        id: find-unity
        run: |
          # Check direct install path first
          $unityExe = "C:\Program Files\Unity\2021.3.36f1\Editor\Unity.exe"
          if (Test-Path $unityExe) {
            Write-Host "Found Unity at: $unityExe"
            echo "unity_path=$unityExe" >> $env:GITHUB_OUTPUT
            exit 0
          }
          # Fallback: search for Unity.exe
          $found = Get-ChildItem -Path "C:\Program Files\Unity" -Recurse -Filter "Unity.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) {
            Write-Host "Found Unity at: $($found.FullName)"
            echo "unity_path=$($found.FullName)" >> $env:GITHUB_OUTPUT
            exit 0
          }
          Write-Error "Unity editor not found! Listing C:\Program Files\Unity:"
          Get-ChildItem -Path "C:\Program Files\Unity" -Recurse -Depth 3 -ErrorAction SilentlyContinue | Select-Object FullName
          exit 1
        shell: pwsh

      - name: "[Build] Build UWP Player"
        run: |
          $unityExe = "${{ steps.find-unity.outputs.unity_path }}"
          Write-Host "Building with Unity: $unityExe"
          Write-Host "Project path: $env:GITHUB_WORKSPACE"

          $process = Start-Process -FilePath $unityExe -ArgumentList @(
            "-batchmode",
            "-nographics",
            "-quit",
            "-projectPath", "$env:GITHUB_WORKSPACE",
            "-buildTarget", "WSAPlayer",
            "-executeMethod", "Editor.Build.BuildUWP.Build",
            "-logFile", "$env:GITHUB_WORKSPACE\unity-build.log"
          ) -Wait -PassThru -NoNewWindow

          if (Test-Path "$env:GITHUB_WORKSPACE\unity-build.log") {
            Write-Host "=== Unity Build Log (last 200 lines) ==="
            Get-Content "$env:GITHUB_WORKSPACE\unity-build.log" -Tail 200
          }

          if ($process.ExitCode -ne 0) {
            Write-Error "Unity build failed with exit code: $($process.ExitCode)"
            exit 1
          }
          Write-Host "Unity build completed successfully!"
        shell: pwsh
        timeout-minutes: 120

      ###########################
      #   Build Visual Studio   #
      ###########################
      - name: "[Build] Setup MSBuild"
        uses: microsoft/setup-msbuild@v2

      - name: "[Build] Install NuGet CLI"
        run: choco install nuget.commandline -y --no-progress
        shell: pwsh

      - name: "[Build] Patch UWP project (remove WindowsMobile SDK ref)"
        run: |
          # Unity may generate a reference to WindowsMobile extension SDK which
          # isn't installed on the runner. Remove it from all .vcxproj files.
          $vcxFiles = Get-ChildItem -Path "build\WSAPlayer" -Filter "*.vcxproj" -Recurse
          foreach ($f in $vcxFiles) {
            $content = Get-Content $f.FullName -Raw
            if ($content -match 'WindowsMobile') {
              Write-Host "Patching $($f.FullName) - removing WindowsMobile SDK reference"
              $content = $content -replace '(?s)<SDKReference\s+Include="WindowsMobile[^"]*"[^/]*/>\s*', ''
              $content = $content -replace '(?s)<SDKReference\s+Include="WindowsMobile[^"]*"[^<]*</SDKReference>\s*', ''
              Set-Content $f.FullName -Value $content -NoNewline
            }
          }
          Write-Host "Project patching complete."
        shell: pwsh

      - name: "[Build] Find and build UWP solution"
        run: |
          $slnPath = Get-ChildItem -Path "build\WSAPlayer" -Filter "*.sln" -Recurse | Select-Object -First 1
          if (-not $slnPath) {
            Write-Error "No .sln file found in build\WSAPlayer"
            Get-ChildItem -Path "build" -Recurse | Select-Object FullName
            exit 1
          }
          Write-Host "Found solution: $($slnPath.FullName)"

          nuget restore $slnPath.FullName

          msbuild $slnPath.FullName `
            /p:Configuration=Master `
            /p:Platform=x64 `
            /p:AppxBundle=Never `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="$($slnPath.DirectoryName)\YARG\WSATestCertificate.pfx" `
            /p:PackageCertificatePassword="" `
            /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxPackageDir="$env:GITHUB_WORKSPACE\AppxPackages\"
        shell: pwsh

      ###########################
      #    Fallback: Zip raw    #
      ###########################
      - name: "[Build] Upload Unity build log"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unity-build-log
          path: |
            unity-build.log
            activation.log
          if-no-files-found: ignore

      - name: "[Build] Fallback - Zip UWP build output"
        if: failure()
        run: |
          if (Test-Path "build\WSAPlayer") {
            Compress-Archive -Path "build\WSAPlayer\*" -DestinationPath "YARG_v${{ inputs.version }}-Xbox-UWP-RawBuild.zip"
          }
        shell: pwsh

      - name: "[Build] Fallback - Upload raw build"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: YARG_v${{ inputs.version }}-Xbox-UWP-RawBuild
          path: YARG_v${{ inputs.version }}-Xbox-UWP-RawBuild.zip
          if-no-files-found: ignore

      ###########################
      #    Upload Artifacts     #
      ###########################
      - name: "[Post-build] Upload .alf (if generated)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Unity-Activation-File
          path: "*.alf"
          if-no-files-found: ignore

      - name: "[Post-build] Find .appx file"
        id: find-appx
        run: |
          $appx = Get-ChildItem -Path "AppxPackages" -Filter "*.appx" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($appx) {
            $newName = "YARG_v${{ inputs.version }}-Xbox.appx"
            Copy-Item $appx.FullName -Destination $newName
            echo "appx_path=$newName" >> $env:GITHUB_OUTPUT
            echo "found=true" >> $env:GITHUB_OUTPUT
            Write-Host "Found APPX: $($appx.FullName)"
          } else {
            echo "found=false" >> $env:GITHUB_OUTPUT
            Write-Host "No .appx found, check raw build output"
          }
        shell: pwsh

      - name: "[Post-build] Upload .appx"
        if: steps.find-appx.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: YARG_v${{ inputs.version }}-Xbox.appx
          path: ${{ steps.find-appx.outputs.appx_path }}

      - name: "[Post-build] Upload full AppxPackages folder"
        if: steps.find-appx.outputs.found != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: YARG_v${{ inputs.version }}-Xbox-AppxPackages
          path: AppxPackages/
          if-no-files-found: ignore
